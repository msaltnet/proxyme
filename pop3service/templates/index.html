<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProxyMe Email Service</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .email-card {
            border-left: 4px solid #007bff;
            margin-bottom: 1rem;
        }
        .email-card.unread {
            border-left-color: #dc3545;
            background-color: #f8f9fa;
        }
        .email-meta {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .email-preview {
            max-height: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-envelope"></i> ProxyMe Email Service
            </a>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- 통계 카드 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <h3 id="total-emails">-</h3>
                        <p class="mb-0">전체 이메일</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <h3 id="unread-emails">-</h3>
                        <p class="mb-0">읽지 않음</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <h3 id="processed-emails">-</h3>
                        <p class="mb-0">처리됨</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <h3 id="recent-emails">-</h3>
                        <p class="mb-0">최근 7일</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 컨트롤 패널 -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <button class="btn btn-primary" onclick="syncEmails()">
                                    <i class="fas fa-sync"></i> 이메일 동기화
                                </button>
                                <button class="btn btn-success" onclick="loadEmails()">
                                    <i class="fas fa-refresh"></i> 새로고침
                                </button>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="search-sender" placeholder="발신자 검색...">
                                    <button class="btn btn-outline-secondary" onclick="searchEmails()">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 이메일 목록 -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-inbox"></i> 이메일 목록</h5>
                    </div>
                    <div class="card-body">
                        <div id="emails-container">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">이메일을 불러오는 중...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 이메일 상세 모달 -->
    <div class="modal fade" id="emailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="emailModalTitle">이메일 상세</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="emailModalBody">
                    <!-- 이메일 내용이 여기에 표시됩니다 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    <button type="button" class="btn btn-primary" id="markReadBtn" onclick="markAsRead()">읽음 표시</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentEmailId = null;

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            loadStatistics();
            loadEmails();
        });

        // 통계 로드
        async function loadStatistics() {
            try {
                const response = await fetch('/api/statistics');
                const stats = await response.json();
                
                document.getElementById('total-emails').textContent = stats.total_emails || 0;
                document.getElementById('unread-emails').textContent = stats.unread_emails || 0;
                document.getElementById('processed-emails').textContent = stats.processed_emails || 0;
                document.getElementById('recent-emails').textContent = stats.recent_emails || 0;
            } catch (error) {
                console.error('통계 로드 실패:', error);
            }
        }

        // 이메일 목록 로드
        async function loadEmails() {
            const container = document.getElementById('emails-container');
            container.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">이메일을 불러오는 중...</p></div>';

            try {
                const response = await fetch('/api/emails?limit=20');
                const data = await response.json();
                
                if (data.emails && data.emails.length > 0) {
                    displayEmails(data.emails);
                } else {
                    container.innerHTML = '<div class="text-center text-muted"><p>이메일이 없습니다.</p></div>';
                }
            } catch (error) {
                console.error('이메일 로드 실패:', error);
                container.innerHTML = '<div class="alert alert-danger">이메일을 불러오는데 실패했습니다.</div>';
            }
        }

        // 이메일 목록 표시
        function displayEmails(emails) {
            const container = document.getElementById('emails-container');
            let html = '';

            emails.forEach(email => {
                const isUnread = !email.is_read;
                const cardClass = isUnread ? 'email-card unread' : 'email-card';
                
                html += `
                    <div class="card ${cardClass}" onclick="showEmailDetail(${email.id})">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6 class="card-title">
                                        ${email.subject || '(제목 없음)'}
                                        ${isUnread ? '<span class="badge bg-danger ms-2">읽지 않음</span>' : ''}
                                    </h6>
                                    <p class="email-meta">
                                        <strong>발신자:</strong> ${email.sender}<br>
                                        <strong>수신일:</strong> ${new Date(email.date_received).toLocaleString('ko-KR')}
                                    </p>
                                    <div class="email-preview">
                                        ${email.body_text ? email.body_text.substring(0, 200) + '...' : '내용 없음'}
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <small class="text-muted">
                                        ${email.size ? Math.round(email.size / 1024) + ' KB' : ''}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // 이메일 상세 보기
        async function showEmailDetail(emailId) {
            currentEmailId = emailId;
            
            try {
                const response = await fetch(`/api/emails/${emailId}`);
                const email = await response.json();
                
                const modalTitle = document.getElementById('emailModalTitle');
                const modalBody = document.getElementById('emailModalBody');
                const markReadBtn = document.getElementById('markReadBtn');
                
                modalTitle.textContent = email.subject || '(제목 없음)';
                
                modalBody.innerHTML = `
                    <div class="mb-3">
                        <strong>발신자:</strong> ${email.sender}<br>
                        <strong>수신자:</strong> ${email.recipient}<br>
                        <strong>수신일:</strong> ${new Date(email.date_received).toLocaleString('ko-KR')}<br>
                        <strong>크기:</strong> ${email.size ? Math.round(email.size / 1024) + ' KB' : '알 수 없음'}
                    </div>
                    <hr>
                    <div>
                        <h6>내용:</h6>
                        <div style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; padding: 1rem; background-color: #f8f9fa;">
                            ${email.body_html ? email.body_html : (email.body_text ? email.body_text.replace(/\n/g, '<br>') : '내용 없음')}
                        </div>
                    </div>
                `;
                
                markReadBtn.style.display = email.is_read ? 'none' : 'inline-block';
                
                const modal = new bootstrap.Modal(document.getElementById('emailModal'));
                modal.show();
                
            } catch (error) {
                console.error('이메일 상세 로드 실패:', error);
                alert('이메일을 불러오는데 실패했습니다.');
            }
        }

        // 읽음 표시
        async function markAsRead() {
            if (!currentEmailId) return;
            
            try {
                const response = await fetch(`/api/emails/${currentEmailId}/read`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    loadEmails();
                    loadStatistics();
                    document.getElementById('markReadBtn').style.display = 'none';
                } else {
                    alert('읽음 표시에 실패했습니다.');
                }
            } catch (error) {
                console.error('읽음 표시 실패:', error);
                alert('읽음 표시에 실패했습니다.');
            }
        }

        // 이메일 동기화
        async function syncEmails() {
            const button = event.target;
            const originalText = button.innerHTML;
            
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 동기화 중...';
            button.disabled = true;
            
            try {
                const response = await fetch('/api/sync', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        delete_from_server: false
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`동기화 완료!\n새 메시지: ${result.new_messages}개\n업데이트: ${result.updated_messages}개`);
                    loadEmails();
                    loadStatistics();
                } else {
                    alert('동기화에 실패했습니다: ' + (result.error || '알 수 없는 오류'));
                }
            } catch (error) {
                console.error('동기화 실패:', error);
                alert('동기화에 실패했습니다.');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // 발신자 검색
        function searchEmails() {
            const sender = document.getElementById('search-sender').value;
            if (sender.trim()) {
                // 검색 기능 구현 (간단한 예시)
                loadEmails(); // 실제로는 검색 파라미터를 추가해야 함
            }
        }

        // Enter 키로 검색
        document.getElementById('search-sender').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchEmails();
            }
        });
    </script>
</body>
</html>
